# Phase 2.4: アニメーション課題 - 制御の可視化

## 目的

制御系シミュレーションの結果を**アニメーション**で可視化し、制御方式の有効性を直感的に理解する。
PID制御などの制御理論が実社会でどのように機能しているかを、身近な実装例を通じて学習する。

---

## 概要

### 問題設定

従来のプロット表示では、制御信号と出力の時間推移が可視化されていますが、
実世界で実際に何が起こっているのかが直感的に理解しにくい課題があります。

- ❌ グラフだけでは「なぜこの応答なのか」が分からない
- ✅ アニメーション表示により「実際の動き」が理解できる

### 解決策

身近で実用化されたシステムの**アニメーション表示**を通じて、
制御理論と実装の関係性を視覚的に学習します。

---

## 実装範囲

### 対象課題（全3種類）

#### 1. **エレベータシミュレーション** (優先度: 高)

**現実の例**: 高層建築のエレベータ制御

**仕様:**
- **目標**: 目標階へのスムーズな移動
- **制御対象**: 位置制御 + 速度制御
- **表示内容**:
  - 左側: エレベータの上下アニメーション
  - 右側: リアルタイムグラフ（位置・速度）
  - インジケータ: 現在階・目標階の表示

**制御パラメータ**:
- 初期位置: 1階
- 目標位置: 可変選択（1～10階）
- 移動距離: 1階あたり3m
- 最大速度: 2 m/s
- 加速度制限: 1 m/s²

**グラフ表示**:
```
位置 [m]          速度 [m/s]        加速度 [m/s²]
 ↑                 ↑                 ↑
30 |━━━━━━━━━━    2.0 |╱╲╱╲╱╲      1.0 |╱╲
20 |      ━━━━━   1.0 |    ╲    ╲  0   |  ╲__
10 |━━━━━        0   |      ╲    ╲ -1.0|
 0 |━━━━━━━━━━   -2.0|       ╲╲╲╲╲ 
   └────────────      └────────────     └────────
```

**実装ファイル構成**:
```
lib/ui/
├── animations/
│   ├── elevator_animation.dart      # エレベータ表示ウィジェット
│   ├── models/
│   │   └── elevator_state.dart      # エレベータの状態管理
│   └── components/
│       ├── elevator_cabin.dart      # キャビン描画
│       └── floor_indicator.dart     # 階数表示
└── phase2_4/
    ├── elevator_exercise.dart       # 課題ページ
    └── elevator_controller.dart     # 制御ロジック
```

**レイアウト**:
```
┌─────────────────────────────────────────┐
│  エレベータシミュレーション              │
├──────────────────┬──────────────────────┤
│                  │                      │
│ 🏢 (Animation)   │  グラフ表示          │
│  階数表示        │  ├─位置             │
│  速度表示        │  ├─速度             │
│                  │  └─加速度           │
├──────────────────┼──────────────────────┤
│ コントロール:                           │
│ 目標階: [ドロップダウン]                │
│ [開始] [停止] [リセット]                │
└──────────────────┴──────────────────────┘
```

---

#### 2. **車両速度制御** (優先度: 中)

**現実の例**: クルーズコントロール機能、自動運転の速度制御

**仕様:**
- **目標**: 目標速度への加速・維持
- **制御対象**: 速度制御（PID制御）
- **表示内容**:
  - 上部: 車両の走行アニメーション（横スクロール）
  - 下部: リアルタイムグラフ（速度・加速度・制御力）

**制御パラメータ**:
- 初期速度: 0 km/h
- 目標速度: 可変選択（0～120 km/h）
- 最大加速度: 5 m/s²
- エンジン出力限界: 200 kW

**グラフ表示**:
```
速度 [km/h]       制御力 [N]
 ↑               ↑
120|      ━━━━━━  2000|╱╱╱╱╱
 60|    ╱╱╱╱     1000|      ╲╲╲
  0|━━━━━━━━━━   0    |━━━━━━━
   └────────────     └────────────
```

**実装ファイル構成**:
```
lib/ui/
├── animations/
│   ├── vehicle_animation.dart       # 車両表示ウィジェット
│   ├── models/
│   │   └── vehicle_state.dart       # 車両の状態管理
│   └── components/
│       ├── car_sprite.dart          # 車の描画
│       └── road_painter.dart        # 道路の描画
└── phase2_4/
    ├── vehicle_exercise.dart        # 課題ページ
    └── vehicle_controller.dart      # 制御ロジック
```

**レイアウト**:
```
┌─────────────────────────────────────────┐
│  車両速度制御シミュレーション            │
├─────────────────────────────────────────┤
│ 🚗 ─────────────────────────────────    │
│ [Road Animation]                        │
├─────────────────────────────────────────┤
│ グラフ:                                 │
│ ├─速度 [km/h]                          │
│ ├─加速度 [m/s²]                        │
│ └─制御力 [kN]                          │
├─────────────────────────────────────────┤
│ コントロール:                           │
│ 目標速度: [スライダー 0-120km/h]        │
│ [開始] [停止] [リセット]                │
└─────────────────────────────────────────┘
```

---

#### 3. **温度制御炉** (優先度: 中)

**現実の例**: 産業用炉、化学反応槽、温度管理

**仕様:**
- **目標**: 目標温度への加熱・冷却制御
- **制御対象**: 温度制御（適応制御またはPID制御）
- **表示内容**:
  - 左側: 炉の色変化アニメーション（温度に応じて色変化）
  - 右側: リアルタイムグラフ（温度・ヒータ出力）
  - テキスト: 現在温度・目標温度の表示

**制御パラメータ**:
- 初期温度: 25°C
- 目標温度: 可変選択（25～500°C）
- 時定数: 10秒（温度上昇）
- 最大ヒータ出力: 100%

**温度と色の対応**:
- 25°C: 青色
- 100°C: 緑色
- 300°C: 黄色
- 500°C: 赤色

**グラフ表示**:
```
温度 [°C]         ヒータ出力 [%]
 ↑               ↑
500|      ━━━━━━  100|╱╱╱╱╱╱
250|    ╱╱╱╱     50 |     ╲╲╲╲
  0|━━━━━━━━━━    0 |━━━━━━━
   └────────────     └────────────
```

**実装ファイル構成**:
```
lib/ui/
├── animations/
│   ├── furnace_animation.dart       # 炉表示ウィジェット
│   ├── models/
│   │   └── furnace_state.dart       # 炉の状態管理
│   └── components/
│       ├── furnace_body.dart        # 炉の描画
│       └── temperature_indicator.dart # 温度表示
└── phase2_4/
    ├── furnace_exercise.dart        # 課題ページ
    └── furnace_controller.dart      # 制御ロジック
```

**レイアウト**:
```
┌─────────────────────────────────────────┐
│  温度制御炉シミュレーション              │
├──────────────────┬──────────────────────┤
│                  │ グラフ:              │
│ 🔥 (Color)       │ ├─温度 [°C]          │
│  温度: 350°C     │ └─ヒータ出力 [%]     │
│  目標: 500°C     │                      │
├──────────────────┼──────────────────────┤
│ コントロール:                           │
│ 目標温度: [スライダー 25-500°C]         │
│ [開始] [停止] [リセット]                │
└──────────────────┴──────────────────────┘
```

---

## 技術仕様

### アーキテクチャ

```dart
// 共通インターフェース
abstract class AnimationExercise {
  void start();
  void stop();
  void reset();
  void setTargetValue(double value);
  Stream<SimulationState> get stateStream;
}

// 各課題の実装クラス
class ElevatorExercise extends AnimationExercise { ... }
class VehicleExercise extends AnimationExercise { ... }
class FurnaceExercise extends AnimationExercise { ... }
```

### 状態管理

各課題で統一されたシミュレーション状態を管理：

```dart
class SimulationState {
  final double currentValue;      // 現在値（位置/速度/温度など）
  final double targetValue;       // 目標値
  final double controlSignal;     // 制御信号
  final List<double> history;     // 履歴データ
  final DateTime timestamp;       // タイムスタンプ
  final bool isRunning;          // 実行中フラグ
}
```

### グラフィックス

**Animation Framework:**
- Flutter の `AnimatedBuilder` と `Animation` を使用
- `AnimationController` でタイミングを管理
- `CustomPaint` で複雑な図形を描画

**パフォーマンス最適化:**
- 60 FPS でのレンダリング
- 不要な再描画を避ける（`RepaintBoundary`）
- メモリ効率を考慮した履歴データ管理（最新1000点までを保持）

### シミュレーション連携

既存の `Simulator` クラスと統合：

```dart
// 既存コード
final simulator = Simulator(plant, controller);
final results = simulator.run(duration);

// 拡張: リアルタイムストリーミング
simulator.runAsStream().listen((state) {
  // アニメーション更新
  _updateAnimation(state);
});
```

---

## 学習効果

### 各課題での学習ポイント

#### エレベータシミュレーション
- ✅ 位置制御の基礎
- ✅ 加速度制限の実装効果
- ✅ 乗り心地の重要性（滑らかな加減速）

#### 車両速度制御
- ✅ フィードバック制御の役割
- ✅ 外乱への対応（加速・減速）
- ✅ PID制御パラメータの効果

#### 温度制御炉
- ✅ 時定数の概念
- ✅ 定常偏差と振動の関係
- ✅ 適応制御の必要性

---

## 開発スケジュール

### Phase 2.4.1: エレベータシミュレーション (Week 1)
- [ ] `elevator_animation.dart` 実装
- [ ] `ElevatorExercise` ウィジェット実装
- [ ] テスト追加
- [ ] 統合テスト

### Phase 2.4.2: 車両速度制御 (Week 2)
- [ ] `vehicle_animation.dart` 実装
- [ ] `VehicleExercise` ウィジェット実装
- [ ] テスト追加
- [ ] 統合テスト

### Phase 2.4.3: 温度制御炉 (Week 3)
- [ ] `furnace_animation.dart` 実装
- [ ] `FurnaceExercise` ウィジェット実装
- [ ] テスト追加
- [ ] 統合テスト

### Phase 2.4.4: UI統合 (Week 4)
- [ ] Main Screen に課題ページへのナビゲーション追加
- [ ] ドキュメント完成
- [ ] 全体テスト

---

## テスト方針

### 単体テスト

```dart
// test/ui/animations/elevator_animation_test.dart
group('ElevatorAnimation', () {
  test('初期位置が正しく表示されること', () { ... });
  test('上昇アニメーションが正しく機能すること', () { ... });
  test('目標階に到達すると停止すること', () { ... });
});
```

### ウィジェットテスト

```dart
// test/ui/phase2_4/elevator_exercise_test.dart
group('ElevatorExercise', () {
  testWidgets('UI要素がすべて表示されること', (tester) { ... });
  testWidgets('目標階の変更が反映されること', (tester) { ... });
  testWidgets('制御ボタンが動作すること', (tester) { ... });
});
```

### 統合テスト

- 実際のシミュレーション結果とアニメーションの同期確認
- グラフ表示の正確性確認
- パフォーマンス測定（メモリ使用量、フレームレート）

---

## 参考資料 (STR実用化例)

### 建築設備

| 対象 | 制御方式 | メーカー例 |
|-----|--------|---------|
| エレベータ | 位置・速度制御 | 日立、三菱電機、東芝 |
| HVAC（冷暖房） | 温度・湿度制御 | ダイキン、富士通 |
| 照度制御 | 照度フィードバック制御 | パナソニック、東芝 |

### 自動車

| 対象 | 制御方式 | 応用例 |
|-----|--------|-------|
| クルーズコントロール | 速度制御 | 全メーカー |
| ABS | ホイール速度制御 | 全メーカー |
| 姿勢制御（ESC） | ヨーレート制御 | 全メーカー |
| パワーステアリング | トルク制御 | 全メーカー |

### 製造業

| 対象 | 制御方式 | 応用例 |
|-----|--------|-------|
| 温度制御 | PID + 適応制御 | 炉、反応槽 |
| 位置制御 | サーボ制御 | ロボット、工作機械 |
| 圧力制御 | フィードバック制御 | 油圧装置 |
| 速度制御 | インバータ制御 | モータドライブ |

---

## 評価基準

### 実装完了の条件

- ✅ すべてのアニメーションが60 FPS以上で滑らかに動作
- ✅ グラフがシミュレーション結果と同期
- ✅ 全テストがパス
- ✅ `flutter analyze` でエラー・警告なし
- ✅ ドキュメント完成

### 学習効果の測定

- 課題完了後、制御パラメータ変更による効果を直感的に理解できるか
- 異なる制御方式の違いを視覚的に認識できるか

---

**作成日**: 2026年1月12日  
**バージョン**: 1.0  
**ステータス**: 提案中
